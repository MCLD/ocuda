@model Ocuda.Ops.Controllers.Areas.ContentManagement.ViewModels.SectionViewModel

<div class="modal fade" id="addLinkLibModal" tabindex="-1" role="dialog" aria-labelledby="listModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="row">
            <div class="col-12 col-sm-10 col-sm-offset-1">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addModalTitle">Add Link Library</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form asp-action="@nameof(SectionController.AddLinkLibrary)"
                          method="post"
                          role="form"
                          enctype="multipart/form-data">
                        <div class="modal-body">
                            <div id="modalItemList" class="col-12">
                                <div class="col-sm-9">

                                    <input asp-for="Section.Stub"
                                           value="@Model.Section.Stub"
                                           autocomplete="off"
                                           type="hidden" />
                                    <input asp-for="LinkLibrary.Stub"
                                           autocomplete="off"
                                           type="hidden" />
                                    <input asp-for="LinkLibrary.Name"
                                           autocomplete="off"
                                           formgroup />
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" value="Submit" class="btn btn-primary">Save</button>
                            <button type="button"
                                    class="btn btn-default"
                                    data-dismiss="modal"
                                    style="margin-right: 1em;">
                                Close
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade"
     id="editLibModal"
     tabindex="-1"
     role="dialog"
     aria-labelledby="listModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="row">
            <div class="col-12 col-sm-10 col-sm-offset-1">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addModalTitle"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form method="post"
                          role="form"
                          id="editForm">
                        <div class="modal-body">
                            <div id="modalItemList" class="col-12">
                                <div class="col-sm-9">

                                    <input asp-for="Section.Stub"
                                           value="@Model.Section.Stub"
                                           autocomplete="off"
                                           type="hidden" />
                                    <input asp-for="FileLibrary.Stub"
                                           autocomplete="off"
                                           type="hidden" />
                                    <input asp-for="LinkLibrary.Stub"
                                           autocomplete="off"
                                           type="hidden" />
                                    <input asp-for="LinkLibrary.Id"
                                           autocomplete="off"
                                           type="hidden" value="0" />
                                    <input asp-for="FileLibrary.Id"
                                           autocomplete="off"
                                           type="hidden" value="0" />
                                    <input asp-for="FileLibrary.Name"
                                           autocomplete="off"
                                           formgroup />
                                    <input asp-for="LinkLibrary.Name"
                                           autocomplete="off"
                                           formgroup />
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" value="submit" class="btn btn-primary">Save</button>
                            <button type="button"
                                    class="btn btn-default"
                                    data-dismiss="modal"
                                    style="margin-right: 1em;">
                                Close
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade"
     id="addFileLibModal"
     tabindex="-1"
     role="dialog"
     aria-labelledby="listModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="row">
            <div class="col-12 col-sm-10 col-sm-offset-1">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addModalTitle">Add File Library</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form asp-action="@nameof(SectionController.AddFileLibrary)"
                          method="post"
                          role="form"
                          enctype="multipart/form-data">
                        <div class="modal-body">
                            <div id="modalItemList" class="col-12">
                                <div class="col-sm-9">

                                    <input asp-for="Section.Stub"
                                           value="@Model.Section.Stub"
                                           autocomplete="off"
                                           type="hidden" />
                                    <input asp-for="FileLibrary.Stub"
                                           autocomplete="off"
                                           type="hidden" />
                                    <input asp-for="FileLibrary.Name"
                                           autocomplete="off"
                                           formgroup />
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit"
                                    value="Submit"
                                    class="btn btn-primary">
                                Save
                            </button>
                            <button type="button"
                                    class="btn btn-default"
                                    data-dismiss="modal"
                                    style="margin-right: 1em;">
                                Close
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade"
     id="deleteModal"
     tabindex="-1"
     role="dialog"
     aria-labelledby="deleteModalLabel">
    <div class="modal-dialog" role="document">
        <form id="deleteForm"
              method="post"
              role="form">
            <input asp-for="Section.Stub" value="@Model.Section.Stub" type="hidden" />
            <input asp-for="FileLibrary.Id" type="hidden" />
            <input asp-for="LinkLibrary.Id" type="hidden" />
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="deleteModalLabel">Delete Feature</h4>
                    <button type="button"
                            class="close"
                            data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>
                    <span id="modal-text"></span>
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-default"
                            data-dismiss="modal"
                            style="margin-right: 1em;">
                        Cancel
                    </button>
                    <button type="submit"
                            class="btn btn-danger btn-spinner pull-right"
                            aria-label="Confirm"
                            id="confirmDelButton">
                        Delete
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a href="@Url.Action(nameof(SectionController.Index))" class="navbar-brand">Section</a>
    <span class="navbar-brand">/</span>
    <a href="@Url.Action(nameof(SectionController.Section),
        new { sectionStub = Model.Section.Stub})"
       class="navbar-brand">@Model.Section.Name</a>
    <a class="nav-link"
       href="@Url.Action(nameof(SectionController.Posts),
            new { sectionStub = Model.Section.Stub})">
        Posts
    </a>
</nav>
<div class="row">
    <div class="col-9">
        @if (!string.IsNullOrEmpty(Model.Section.EmbedVideoUrl))
        {
            <div class="col-9">
                <iframe width="590"
                        height="332"
                        src="@Model.Section.EmbedVideoUrl"
                        frameborder="0"
                        allowfullscreen=""></iframe>
            </div>
        }
        @if (!Model.AllPosts.Any())
        {
            @:No Posts have been made.
        }
        else
        {
            @foreach (var post in Model.AllPosts)
            {
                <div class="row m-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header p-4" style="transform: rotate(0);">
                                <div class="float-left align-middle">
                                    <a class="float-left align-middle" href="@Url.Action(nameof(SectionController.PostDetails),
                                        new { sectionStub = Model.Section.Stub, postStub = post.Stub})">
                                        <h5>
                                            @post.Title
                                        </h5>
                                    </a>
                                </div>
                                <div class="float-right align-middle h4">
                                    <a href="@Url.Action(nameof(SectionController.EditPost), new { sectionStub = Model.Section.Stub, postStub = post.Stub})">
                                        <span class="far fa-edit float-right"></span>
                                    </a>
                                </div>
                            </div>
                            <div class="card-body">
                                @Html.Raw(post.Content)
                            </div>
                            <div class="card-footer">
                                <div class="row font-italic">
                                    Posted: @post.PublishedAt.ToString("MM/dd/yyyy hh:mm tt")
                                </div>
                                @if (Model.PostCategories.Count > 0)
                                {
                                    <div class="font-italic">
                                        Category:&nbsp;
                                        <span>
                                            @foreach (var category in Model.PostCategories
                                             .Where(_ => _.PostId == post.Id)
                                             .Select(_ => Model.SectionCategories.Where(__ => __.Id == _.CategoryId).FirstOrDefault()).ToList())
                                            {
                                                <a class="badge badge-pill badge-info"
                                                   href="@Url.Action(nameof(SectionController.Posts),
                                        new { sectionStub = Model.Section.Stub,
                                        categoryStub = category.Stub, page = 1})">
                                                    @category.Name
                                                </a>
                                            }
                                        </span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
            @if (Model.PaginateModel.MaxPage > 1)
            {
                <paginate paginateModel="@Model.PaginateModel"></paginate>
            }
        }
    </div>
    <div class="col-3">
        <div class="row">
            <table class="table table-condensed table-bordered table-hover">
                <thead>
                    <tr>
                        <th colspan="3">
                            File Libraries
                            <div class="float-right align-middle">
                                <a role="button"
                                   class="text-success align-middle"
                                   id="addFileLibrary"
                                   data-toggle="modal"
                                   data-target="#addFileLibModal">
                                    <span class="fas fa-plus-circle fa-lg align-middle"></span>
                                </a>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.FileLibraries.Count > 0)
                    {
                        @foreach (var library in Model.FileLibraries)
                        {
                            <tr>
                                <td class="row-link file-item text-center" data-stub="@library.Stub">
                                    @library.Name
                                </td>
                                <td style="position: relative;" class="text-center">
                                    <a role="button"
                                       class="text-danger h4 editfile text-center"
                                       data-toggle="modal"
                                       data-target="#editLibModal"
                                       data-id="@library.Id"
                                       data-name="@library.Name"
                                       data-stub="@library.Stub"
                                       data-type="file">
                                        <span class="far fa-edit float-right"></span>
                                    </a>
                                </td>
                                <td style="position: relative;" class="text-center">
                                    <button type="button"
                                            class="btn btn-danger"
                                            data-toggle="modal"
                                            data-target="#deleteModal"
                                            data-id="@library.Id"
                                            data-name="@library.Name"
                                            data-stub="@library.Stub"
                                            data-type="file">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td>
                                No File Libraries exist
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="row">
            <table class="table table-condensed table-bordered table-hover">
                <thead>
                    <tr>
                        <th colspan="3">
                            Link Libraries
                            <div class="float-right align-middle">
                                <a role="button"
                                   class="text-success align-middle"
                                   data-toggle="modal"
                                   data-target="#addLinkLibModal"
                                   id="addLinkLibrary">
                                    <span class="fas fa-plus-circle fa-lg align-middle"></span>
                                </a>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.LinkLibraries.Count > 0)
                    {
                        @foreach (var library in Model.LinkLibraries)
                        {
                            <tr>
                                <td class="row-link link-item text-center" data-stub="@library.Stub">
                                    @library.Name
                                </td>
                                <td style="position: relative;" class="text-center align-middle">
                                    <a role="button"
                                       class="text-danger h4 editlink"
                                       data-toggle="modal"
                                       data-target="#editLibModal"
                                       data-id="@library.Id"
                                       data-name="@library.Name"
                                       data-stub="@library.Stub"
                                       data-type="link">
                                        <span class="far fa-edit float-right"></span>
                                    </a>
                                </td>
                                <td style="position: relative;" class="text-center">
                                    <button type="button"
                                            class="btn btn-danger"
                                            data-toggle="modal"
                                            data-target="#deleteModal"
                                            data-id="@library.Id"
                                            data-name="@library.Name"
                                            data-stub="@library.Stub"
                                            data-type="link">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td>
                                No Link Libraries exist
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
@section scripts {
    <script>
        $(".row-link.file-item").on("click", function () {
            var link = "@Url.Action(nameof(SectionController.FileLibrary), new { sectionStub = Model.Section.Stub, fileLibStub = 0 })";
            link = link.replace("0", $(this).data("stub"));
            window.location.href = link;
        });

        $(".row-link.link-item").on("click", function () {
            var link = "@Url.Action(nameof(SectionController.LinkLibrary), new { sectionStub = Model.Section.Stub, linkLibStub = 0 })";
            link = link.replace("0", $(this).data("stub"));
            window.location.href = link;
        });
        $(".editfile").on("click", function () {
            var button = $(this);
            var id = button.data("id");
            var name = button.data("name");
            var modal = $("#editLibModal");
            modal.find("#FileLibrary_Name").parent().parent().show();
            modal.find("#LinkLibrary_Name").parent().parent().hide();
            modal.find("#addModalTitle").text("Edit File Library "+name);
            modal.find("#FileLibrary_Id").val(id);
            modal.find("#FileLibrary_Name").val(name);
            modal.find("#editForm").attr("action", "@nameof(SectionController.UpdateFileLibrary)");
        });
        $(".editlink").on("click", function () {
            var button = $(this);
            var id = button.data("id");
            var name = button.data("name");
            var modal = $("#editLibModal");
            modal.find("#LinkLibrary_Name").parent().parent().show();
            modal.find("#FileLibrary_Name").parent().parent().hide();
            modal.find("#addModalTitle").text("Edit Link Library "+name);
            modal.find("#LinkLibrary_Id").val(id);
            modal.find("#LinkLibrary_Name").val(name);
            modal.find("#editForm").attr("action", "@nameof(SectionController.UpdateLinkLibrary)");

        });
        $("#editForm").submit(function () {
            if ($("#editForm").find("#LinkLibrary_Name").val()) {
                linkstub = $("#editForm").find("#LinkLibrary_Name").val().toLowerCase().replace(/[^a-zA-Z0-9]/g, '').replace(/ /g,"-");
                $("#editForm").find("#LinkLibrary_Stub").val(linkstub);
                $("#editForm").find("#FileLibrary_Name").remove();
                $("#editForm").find("#FileLibrary_Stub").remove();
            }
            else {
                filestub =  $("#editForm").find("#FileLibrary_Name").val().toLowerCase().replace(/[^a-zA-Z0-9]/g, '').replace(/ /g,"-");
                $("#editForm").find("#FileLibrary_Stub").val(filestub);
                $("#editForm").find("#LinkLibrary_Name").remove();
                $("#editForm").find("#LinkLibrary_Stub").remove();
            }
        });
        $("#addLinkLibModal").submit(function (event) {
            stub = $("#addLinkLibModal").find("#LinkLibrary_Name").val().toLowerCase().replace(/ /g,"-").replace(/[^a-zA-Z0-9]/g, '');
            $("#addLinkLibModal").find("#LinkLibrary_Stub").val(stub);
        });
        $("#addFileLibModal").submit(function (event) {
            stub = $("#addFileLibModal").find("#FileLibrary_Name").val().toLowerCase().replace(/ /g, "-").replace(/[^a-zA-Z0-9]/g, '');
            $("#addFileLibModal").find("#FileLibrary_Stub").val(stub);
        });
        $("#confirmDelButton").on("click", function () {
            $(this).html("Delete <span class='fa fa-spinner fa-pulse fa-lg fa-fw hidden'></span>");
        });
        $("#deleteModal").on("show.bs.modal", function (e) {
            var button = $(e.relatedTarget);
            var id = button.data("id");
            var name = button.data("name");
            var modal = $(this);
            var linklib = $("#deleteModal").find('#LinkLibrary_Id');
            var filelib = $("#deleteModal").find('#FileLibrary_Id');
            if (button.data("type") == "link") {
                if (filelib.length) {
                    filelib.remove();
                }
                if (linklib.length) {
                    linklib.val(id);
                }
                else {
                    $('<input>').attr({
                        type: 'hidden',
                        id: 'LinkLibrary_Id',
                        name: 'LinkLibrary.Id',
                        value: id,
                        class: "input-validation-error"
                    }).attr("aria-describedby", "LinkLibrary_Id-error").appendTo('#deleteForm');
                }
                modal.find("#deleteForm").attr("action", "@Url.Action(nameof(SectionController.DeleteLinkLibrary))");
                modal.find("#modal-text").text("Are you sure you want to delete the link library \"" + name + "\"?");
            }
            else {
                if (linklib.length) {
                    linklib.remove();
                }
                if (filelib.length) {
                    filelib.val(id);
                }
                else {
                    $('<input>').attr({
                        type: 'hidden',
                        id: 'FileLibrary_Id',
                        name: 'FileLibrary.Id',
                        value: id,
                        class: "input-validation-error"
                    }).attr("aria-describedby", "FileLibrary_Id-error").appendTo('#deleteForm');
                }
                modal.find("#deleteForm").attr("action","@Url.Action(nameof(SectionController.DeleteFileLibrary))");
                modal.find("#modal-text").text("Are you sure you want to delete the file library \"" + name + "\"?");
            }
        });
    </script>
}